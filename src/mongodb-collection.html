<script type="text/javascript">
    (function() {
        function isString(v) {
            return typeof v === 'string';
        }

        function isNumber(v) {
            return typeof v === 'number';
        }

        function toNativePomise(jqPromise) {
            return new Promise((resolve, reject) => {
                jqPromise.then(resolve).catch(reject);
            });
        }

        RED.nodes.registerType('mongodb-collection', {
            category: 'database',
            defaults: {
                name: {
                    value: 'MongoDB',
                    required: true,
                    validate: isString,
                },
                config: {
                    value: '',
                    required: true,
                    type: 'mongodb-config',
                },
                collection: {
                    value: '',
                    validate: isString,
                },
                method: {
                    value: '',
                    required: true,
                },
                outputs: {
                    value: 1,
                    validate: isNumber,
                },
                options: {
                    value: '',
                    validate: isString,
                },
            },
            icon: 'mongodb.png',
            inputs: 1,
            outputs: 1,
            outputLabels: ['result'],
            color: '#13aa52',
            label: function() {
                return this.name || 'MongoDB Collection';
            },
            oneditprepare: function() {
                const $method = $('#node-input-method');
                const $outputs = $('#node-input-outputs');
                const $options = $('#node-input-options');
                const loadMethods = configId => {
                    return toNativePomise(
                        $.getJSON('mongodb/collection/methods'),
                    );
                };
                const renderMethods = methods => {
                    $method.empty();

                    const currentMethod = this.method;

                    $method.append(
                        `<option value="">-- Select method --</option>`,
                    );

                    $.each(methods, (_, method) => {
                        const selected =
                            method === currentMethod ? 'selected' : '';

                        $method.append(
                            `<option value="${method}" ${
                                selected ? 'selected' : ''
                            }>${method}</option>`,
                        );
                    });
                };
                const $optsEditor = RED.editor.createEditor({
                    id: 'node-input-options-editor',
                    mode: 'ace/mode/json',
                    value: $options.val(),
                });

                $optsEditor.getSession().on('change', function() {
                    $options.val($optsEditor.getSession().getValue());
                });

                const $tabsContent = $(
                    '#node-input-mongodb-collection-tabs-content',
                );
                const $tabs = RED.tabs.create({
                    id: 'node-input-mongodb-collection-tabs',
                    onchange: function(tab) {
                        $tabsContent.children().hide();

                        $('#' + tab.id).show();

                        // if (tab.id === 'amqp-server-tab-topology') {
                        //     functionDialogResize();
                        // }
                    },
                });

                $tabs.addTab({
                    id: 'node-input-mongodb-collection-tab-collection',
                    label: 'Collection',
                });

                $tabs.addTab({
                    id: 'node-input-mongodb-collection-tab-options',
                    label: 'Options',
                });

                setTimeout(function() {
                    $tabs.resize();
                }, 0);

                loadMethods()
                    .then(renderMethods)
                    .catch(err => {
                        alert(
                            'Failed to retrieve list of MongoDB Collection methods',
                        );

                        console.error(err);
                    });

                $outputs.spinner({
                    min: 1,
                    max: 2,
                    change: function(event, ui) {
                        var value = this.value;

                        if (!value.match(/^\d+$/)) {
                            value = 1;
                        } else if (value < this.min) {
                            value = this.min;
                        }

                        if (value !== this.value) {
                            $(this).spinner('value', value);
                        }
                    },
                });

                $outputs.change(evt => {
                    if (evt.target.value > 1) {
                        this.outputLabels = ['result', 'error'];
                    } else {
                        this.outputLabels = ['result'];
                    }
                });
            },
        });
    })();
</script>

<script type="text/x-red" data-template-name="mongodb-collection">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-input-mongodb-collection-tabs"></ul>
    </div>
    <div id="node-input-mongodb-collection-tabs-content" style="min-height: 170px;">
        <div id="node-input-mongodb-collection-tab-collection" style="display:none">
            <div class="form-row">
                <label for="node-input-config"><i class="fa fa-tasks"></i> <span>Connection:</span></label>
                <select id="node-input-config"></select>
            </div>
            <div class="form-row">
                <label for="node-input-name"><i class="fa fa-tag"></i> Name: </label>
                <input type="text" id="node-input-name" />
            </div>
            <div class="form-row">
                <label for="node-input-collection"><i class="fa fa-folder"></i> Collection: </label>
                <input type="text" id="node-input-collection" />
            </div>
            <div class="form-row">
                <label for="node-input-method"><i class="fa fa-tasks"></i> <span>Method:</span></label>
                <select id="node-input-method"></select>
            </div>
            <div class="form-row">
                <label for="node-input-prop"><i class="fa fa-long-arrow-right"></i> <span>Query:</span></label>
                <input type="text" id="node-input-prop" placeholder="msg.payload" />
            </div>
            <div class="form-row">
                <label for="node-input-outputs"><i class="fa fa-random"></i> <span>Outputs:</span></label>
                <input id="node-input-outputs" style="width: 60px;" />
            </div>
            <div class="form-tips"><b>Tip:</b> This is here to help.</div>
        </div>
        <div id="node-input-mongodb-collection-tab-options" style="display:none">
            <div class="form-row node-text-editor-row">
                <textarea id="node-input-options" style="display: none; resize: vertical; width:100%; height: 10em"></textarea>
                <div style="height: 250px;" class="node-text-editor" id="node-input-options-editor" ></div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="mongodb-collection">
    <p>Some useful help text to introduce the node.</p>
    <h3>Outputs</h3>
        <dl class="message-properties">
        <dt>payload
            <span class="property-type">string | buffer</span>
        </dt>
    <h3>Details</h3>
    <p>Some more information about the node.</p>
</script>
